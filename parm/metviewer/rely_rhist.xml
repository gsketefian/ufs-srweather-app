<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<plot_spec>
    <connection>
        <host>{{mv_host}}</host>
        <database>{{mv_database_name}}</database>
        <user>{{mv_machine_config_dict["user"]}}</user>
        <password>{{mv_machine_config_dict["password"]}}</password>
        <management_system>mariadb</management_system>
    </connection>
    <rscript>{{mv_machine_config_dict["Rscript_fp"]}}</rscript>
    <folders>
        <r_tmpl>{{mv_machine_config_dict["R_tmpl_dir"]}}</r_tmpl>
        <r_work>{{mv_machine_config_dict["R_work_dir"]}}</r_work>
        <plots>{{mv_output_dir}}/plots</plots>
        <data>{{mv_output_dir}}/data</data>
        <scripts>{{mv_output_dir}}/scripts</scripts>
    </folders>
    <plot>
        <template>{{vx_stat_lc}}.R_tmpl</template>
        <series1>
            <field name="model">
{%- set prob_or_null = "" -%}
{%- if (vx_stat_uc == "RELY") -%}
  {%- set prob_or_null = "_prob" -%}
{%- endif -%}
{%- set indent = "\n                " -%}
{%- for imdl in range(1, num_models_to_plot+1) -%}
  {%- set model = model_names_in_db[imdl-1] -%}
  {{- indent ~ "<val>" ~ model ~ prob_or_null ~ "</val>" -}}
{%- endfor %}
            </field>
        </series1>
{%- set ipf = -1 %}
        <plot_fix>
            <field equalize="true" name="fcst_var">
{%- set ipf = ipf+1 %}
                <set name="fcst_var_{{ipf}}">
                    <val>{{fcst_var_name_in_db}}</val>
                </set>
            </field>
            <field equalize="true" name="fcst_init_beg">
{%- set ipf = ipf+1 %}
                <set name="fcst_init_beg_{{ipf}}">
{%- set indent = "\n                    " -%}
{%- for t_init in fcst_init_times -%}
  {{- indent ~ "<val>" ~ t_init ~ "</val>" -}}
{%- endfor %}
                </set>
            </field>
            <field equalize="true" name="vx_mask">
{%- set ipf = ipf+1 %}
                <set name="vx_mask_{{ipf}}">
                    <val>CONUS</val>
                </set>
            </field>
            <field equalize="true" name="obtype">
{%- set ipf = ipf+1 %}
                <set name="obtype_{{ipf}}">
                    <val>{{obs_type}}</val>
                </set>
            </field>
            <field equalize="true" name="fcst_lev">
{%- set ipf = ipf+1 %}
                <set name="fcst_lev_{{ipf}}">
                    <val>{{level_in_db}}</val>
                </set>
            </field>
{%- if (vx_stat_uc == "RELY") -%}
  {%- if (fcst_var_uc in ["APCP","REFC"]) %}
            <field equalize="true" name="interp_mthd">
    {%- set ipf = ipf+1 %}
                <set name="interp_mthd_{{ipf}}">
                    <val>NEAREST</val>
                </set>
            </field>
  {%- endif %}
{%- endif %}
{#- #}
        </plot_fix>
{%- if (vx_stat_uc == "RELY") %}
        <rely_event_hist>true</rely_event_hist>
        <summary_curve/>
        <add_skill_line>true</add_skill_line>
        <add_noskill_line>true</add_noskill_line>
        <add_reference_line>true</add_reference_line>
        <inset_hist>true</inset_hist>
        <agg_stat>
            <agg_pct>true</agg_pct>
            <boot_repl>1</boot_repl>
            <boot_random_seed/>
            <boot_ci>perc</boot_ci>
            <eveq_dis>false</eveq_dis>
            <cl_step/>
        </agg_stat>
{%- elif (vx_stat_uc == "RHIST") %}
        <normalized_histogram>true</normalized_histogram>
{%- endif %}
        <tmpl>
            <data_file>plot_{{job_title}}.data</data_file>
            <plot_file>plot_{{job_title}}.png</plot_file>
            <r_file>plot_{{job_title}}.R</r_file>
            <title>{{plot_title}}</title>
{%- if (vx_stat_uc == "RELY") %}
            <x_label>Forecast Probability</x_label>
            <y1_label>Observed Probability</y1_label>
{%- elif (vx_stat_uc == "RHIST") %}
            <x_label>Bins</x_label>
            <y1_label>Fraction</y1_label>
{%- endif %}
            <y2_label/>
            <caption>{{caption}}</caption>
            <job_title>{{job_title}}</job_title>
            <keep_revisions>false</keep_revisions>
            <listdiffseries1>list()</listdiffseries1>
            <listdiffseries2>list()</listdiffseries2>
        </tmpl>
{%- set xlab_offset = "" -%}
{%- set ylab_offset = "" -%}
{%- set legend_inset_x = "0" -%}
{%- set legend_inset_y = "" -%}
{%- if (vx_stat_uc == "RELY") -%}
  {%- set xlab_offset = "2" -%}
  {%- set ylab_offset = "-2" -%}
  {%- set legend_inset_y = "-.25" -%}
{%- elif (vx_stat_uc == "RHIST") -%}
  {%- set xlab_offset = "6" -%}
  {%- set ylab_offset = "-12" -%}
  {%- set legend_inset_y = "-.24" -%}
{%- endif %}
        <execution_type>Python</execution_type>
        <event_equal>true</event_equal>
        <vert_plot>false</vert_plot>
        <x_reverse>false</x_reverse>
        <num_stats>false</num_stats>
        <indy1_stag>false</indy1_stag>
        <indy2_stag>false</indy2_stag>
        <start_from_zero>false</start_from_zero>
        <grid_on>true</grid_on>
        <sync_axes>false</sync_axes>
        <dump_points1>false</dump_points1>
        <dump_points2>false</dump_points2>
        <log_y1>false</log_y1>
        <log_y2>false</log_y2>
{#-
Variance inflation factor should be turned off according to DTC statisticians.
#}
        <varianceinflationfactor>false</varianceinflationfactor>
        <plot_type>png16m</plot_type>
        <plot_height>8.5</plot_height>
        <plot_width>11</plot_width>
        <plot_res>72</plot_res>
        <plot_units>in</plot_units>
        <mar>c(8,4,5,4)</mar>
        <mgp>c(1,1,0)</mgp>
        <cex>1</cex>
        <title_weight>2</title_weight>
        <title_size>1.4</title_size>
        <title_offset>-2</title_offset>
        <title_align>0.5</title_align>
        <xtlab_orient>1</xtlab_orient>
        <xtlab_perp>-0.75</xtlab_perp>
        <xtlab_horiz>0.5</xtlab_horiz>
        <xtlab_freq>{{xtick_label_freq}}</xtlab_freq>
        <xtlab_size>2</xtlab_size>
        <xlab_weight>1</xlab_weight>
        <xlab_size>6</xlab_size>
        <xlab_offset>{{xlab_offset}}</xlab_offset>
        <xlab_align>0.5</xlab_align>
        <ytlab_orient>1</ytlab_orient>
        <ytlab_perp>0.5</ytlab_perp>
        <ytlab_horiz>0.5</ytlab_horiz>
        <ytlab_size>2</ytlab_size>
        <ylab_weight>1</ylab_weight>
        <ylab_size>6</ylab_size>
        <ylab_offset>{{ylab_offset}}</ylab_offset>
        <ylab_align>0.5</ylab_align>
        <grid_lty>3</grid_lty>
        <grid_col>#cccccc</grid_col>
        <grid_lwd>1</grid_lwd>
        <grid_x>listX</grid_x>
        <x2tlab_orient>1</x2tlab_orient>
        <x2tlab_perp>1</x2tlab_perp>
        <x2tlab_horiz>0.5</x2tlab_horiz>
        <x2tlab_size>0.8</x2tlab_size>
        <x2lab_size>0.8</x2lab_size>
        <x2lab_offset>-0.5</x2lab_offset>
        <x2lab_align>0.5</x2lab_align>
        <y2tlab_orient>1</y2tlab_orient>
        <y2tlab_perp>0.5</y2tlab_perp>
        <y2tlab_horiz>0.5</y2tlab_horiz>
        <y2tlab_size>1</y2tlab_size>
        <y2lab_size>1</y2lab_size>
        <y2lab_offset>1</y2lab_offset>
        <y2lab_align>0.5</y2lab_align>
        <legend_box>o</legend_box>
        <legend_inset>c({{legend_inset_x}}, {{legend_inset_y}})</legend_inset>
{#-
This should be generalized to the number of series being plotted, but
it doesn't seem to make a difference in the final plot.
#}
        <legend_ncol>3</legend_ncol>
        <legend_size>1.5</legend_size>
        <!-- Have the caption weight and color match that of the title.
             Note that it doesn't seem possible to change the title color
             (i.e. there is no <title_col> above), so here we set the
             color of the caption to match that of the title. -->
        <caption_weight>2</caption_weight>
        <caption_col>#2a3f5f</caption_col>
        <caption_size>1.0</caption_size>
        <caption_offset>4.2</caption_offset>
        <caption_align>0.05</caption_align>
        <ci_alpha>0.05</ci_alpha>
        <eqbound_low>-0.001</eqbound_low>
        <eqbound_high>0.001</eqbound_high>
        <!-- These appear in the MetViewer GUI under the column "Conf Interval".
             They specify the type of confidence intervals to plot ("none" for 
             no confidence intervals). -->
        <plot_ci>c(
{%- set plot_ci = "none" -%}
"{{plot_ci}}"
{%- for imdl in range(2, num_models_to_plot+1) -%}
  ,"{{plot_ci}}"
{%- endfor -%})</plot_ci>
{#- #}
        <!-- These appear in the MetViewer GUI under the column "Show Significant".
             Not yet clear on what they do. -->
        <show_signif>c(
{%- set show_signif = "FALSE" -%}
{{show_signif}}
{%- for imdl in range(2, num_models_to_plot+1) -%}
  ,{{show_signif}}
{%- endfor -%})</show_signif>
{#- #}
        <!-- These appear in the MetViewer GUI under the column "Hide", although it
             seems it is the opposite of this that is in the "Hide" column, i.e. if
             an element is set to "TRUE" here, it will show up as "FALSE" in the GUI.
             Not yet clear on what they do. -->
        <plot_disp>c(
{%- set plot_disp = "TRUE" -%}
{{plot_disp}}
{%- for imdl in range(2, num_models_to_plot+1) -%}
  ,{{plot_disp}}
{%- endfor -%})</plot_disp>
{#- #}
        <!-- These appear in the MetViewer GUI under the column "Line Color".
             They control the line colors. -->
        <colors>c(
{%- set color = model_color_codes[0] -%}
"{{color}}"
{%- for imdl in range(2, num_models_to_plot+1) -%}
  {%- set color = model_color_codes[imdl-1] -%}
  ,"{{color}}"
{%- endfor -%})</colors>
{#- #}
        <!-- These appear in the MetViewer GUI under the column "Point Symbol".
             They control the symbols used for the data points of each series. -->
        <pch>c(
{%- set pch = "20" -%}
{{pch}}
{%- for imdl in range(2, num_models_to_plot+1) -%}
  ,{{pch}}
{%- endfor -%})</pch>
{#- #}
        <!-- These appear in the MetViewer GUI under the column "Series Line Type".
             "l" is for lines, and "b" is for "joined lines".
             Not yet clear on what they do. -->
        <type>c(
{%- set type = "b" -%}
"{{type}}"
{%- for imdl in range(2, num_models_to_plot+1) -%}
  ,"{{type}}"
{%- endfor -%})</type>
{#- #}
        <!-- These appear in the MetViewer GUI under the column "Line Type".
             1 is for "solid", 3 is for "dotted".
             They control the line types that join the data points. -->
        <lty>c(
{%- set lty = "1" -%}
{{lty}}
{%- for imdl in range(2, num_models_to_plot+1) -%}
  ,{{lty}}
{%- endfor -%})</lty>
{#- #}
        <!-- These appear in the MetViewer GUI under the column "Line Width".
             They control the widths of the lines that join the data points. -->
        <lwd>c(
{%- set lwd = "" -%}
{%- if (vx_stat_uc == "RELY") -%}
  {%- set lwd = "2" -%}
{%- elif (vx_stat_uc == "RHIST") -%}
  {%- set lwd = "1" -%}
{%- endif -%}
{{lwd}}
{%- for imdl in range(2, num_models_to_plot+1) -%}
  ,{{lwd}}
{%- endfor -%})</lwd>
{#- #}
        <!-- These appear in the MetViewer GUI under the column "Connect Across".
             0 is "no" and 1 is "yes".  
             Not yet clear on what they do. -->
        <con_series>c(
{%- set cs = "1" -%}
{{cs}}
{%- for imdl in range(2, num_models_to_plot+1) -%}
  ,{{cs}}
{%- endfor -%})</con_series>
{#- #}
        <!-- These appear in the MetViewer GUI under the column "#" (number sign).
             They control the order of the series, although details aren't clear. -->
        <order_series>c(
{%- set imdl = 1 -%}
{{imdl}}
{%- for imdl in range(2, num_models_to_plot+1) -%}
  ,{{imdl}}
{%- endfor -%})</order_series>
{#- #}
        <plot_cmd/>
        <!-- These appear in the MetViewer GUI under the column "Legend Text".
             They specify the text that appears in the legend for each series. -->
        <legend>c(
{%- set model = model_names_short[0] -%}
"{{model}}"
{%- for imdl in range(2, num_models_to_plot+1) -%}
  {%- set model = model_names_short[imdl-1] -%}
  ,"{{model}}"
{%- endfor -%})</legend>
        <create_html>TRUE</create_html>
        <y1_lim>c()</y1_lim>
        <x1_lim>c()</x1_lim>
        <y1_bufr>0.04</y1_bufr>
        <y2_lim>c()</y2_lim>
    </plot>
</plot_spec>

